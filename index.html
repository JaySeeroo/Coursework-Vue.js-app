<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="styles.css" />
  <title>Lessons App</title>
</head>
<body>
  <div id="webstore">
    <header>
      <h1>{{ message }}</h1>
      <!-- Toggle between lessons and cart -->
      <button @click="toggleCart" :disabled="showProduct && cart.length === 0" class="cart-toggle-btn">
        <span class="fa-solid fa-cart-shopping"></span>
        <span class="cart-count">{{ itemInCart }}</span>
        <span class="btn-text">{{ showProduct ? 'View Cart' : 'Back to Lessons' }}</span>
      </button>
    </header>

    <main>
      <!-- Lesson List -->
      <div v-if="showProduct">
        <!-- Sorting and search controls -->
        <div class="sort-controls">
          <label for="sortAttribute">Sort by:</label>
          <select v-model="sortAttribute" id="sortAttribute">
            <option value="subject">Subject</option>
            <option value="location">Location</option>
            <option value="price">Price</option>
            <option value="spaces">Spaces</option>
          </select>

          <label for="sortOrder">Order:</label>
          <select v-model="sortOrder" id="sortOrder">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
          </select>

          <label for="search" class="search-label">Search:</label>
            <div class="search-wrapper">
              <i class="fa fa-search"></i>
              <input
                id="search"
                v-model="searchTerm"
                type="search"
                placeholder="Search lessons..."
                class="search-input" />
            </div>
        </div>

        <!-- Loading / error states -->
        <div v-if="loading" class="cart-info">Loading lessons...</div>
        <div v-else-if="error" class="cart-info">{{ error }}</div>

        <div v-else>
          <div v-if="noResults" class="cart-info">
            No lessons found for "{{ searchTerm }}".
          </div>
          <!-- Lesson lIst -->
          <div v-else class="lesson-list">
            <div v-for="lesson in filteredAndSortedLessons" :key="lesson._id" class="lesson-card">
              <img :src="BACKEND_URL + lesson.image" :alt="lesson.subject + ' image'" width="60" height="60">
              <h2>{{ lesson.subject }}</h2>
              <p><strong>Location:</strong> {{ lesson.location }}</p>
              <p><strong>Price:</strong> ${{ lesson.price }}</p>
              <p><strong>Spaces Left:</strong> {{ lesson.spaces - cartCount(lesson._id) }}</p>
              <button @click="addToCart(lesson)" v-if="canAddToCart(lesson)">Add to Cart</button>
              <button disabled v-else>Add to Cart</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Cart Page -->
      <div v-else class="cart-page">
        <h2>Your Shopping Cart</h2>

        <!-- Confirmation after order -->
        <div v-if="orderSubmitted">
          <p class="confirmation">âœ… Your order has been submitted successfully!</p>
        </div>

        <div v-else>
          <!-- Cart items -->
          <div v-if="cart.length > 0">
            <div v-for="lesson in cartLessons" :key="lesson._id" class="lesson-card">
              <img :src="BACKEND_URL + lesson.image" :alt="lesson.subject + ' image'" width="60" height="60">
              <h2>{{ lesson.subject }}</h2>
              <p><strong>Location:</strong> {{ lesson.location }}</p>
              <p><strong>Price:</strong> ${{ lesson.price }}</p>
              <p>Quantity: {{ cartCount(lesson._id) }}</p>
              <button @click="removeFromCart(lesson)">Remove</button>
            </div>

            <!-- Cart summary -->
            <div class="cart-summary">
              <p>Total Items: {{ itemInCart }}</p>
              <p>Total Price: ${{ totalPrice }}</p>
            </div>

            <!-- Checkout form -->
            <div class="checkout-form">
              <h3>Checkout</h3>
              <p>
                <label for="name">Name:</label>
                <input id="name" v-model="order.name" />
                <span v-if="order.name && !isValidName" class="error-msg">
                  Name must contain only letters and spaces.
                </span>
              </p>
              <p>
                <label for="phone">Phone:</label>
                <input id="phone" v-model="order.phone" />
                <span v-if="order.phone && !isValidPhone" class="error-msg">
                  Phone number must be exactly 8 digits.
                </span>
              </p>
              <p>
                <label for="address">Address:</label>
                <input id="address" v-model="order.address" />
              </p>
              <button @click="submitOrder" :disabled="!isValidName || !isValidPhone || submitting">
                {{ submitting ? 'Submitting...' : 'Checkout' }}
              </button>
            </div>
          </div>
          <div v-else><p>Your cart is empty.</p></div>
        </div>
      </div>
    </main>
  </div>

  <script>
  new Vue({
    el: "#webstore",

    // ---------------------------------------------------------
    // Application State
    // ---------------------------------------------------------
    data: {
      BACKEND_URL: "http://localhost:3000",
      message: "Welcome to the Lessons Store!",
      showProduct: true,                 // Toggles between lessons list and cart
      sortAttribute: "subject",          // Current sorting attribute
      sortOrder: "asc",                  // asc | desc
      searchTerm: "",                    // Search input value
      cart: [],                          // Array of lesson IDs currently in cart
      order: { name: "", phone: "", address: "" },  // Checkout form data
      orderSubmitted: false,             // Display confirmation message
      lessons: [],                       // Full lessons list from backend
      searchResults: [],                 // Filtered lessons returned from search
      noResults: false,                  // Flag: search returned no matches
      loading: false,                    // Display loading state
      error: "",                         // Holds error messages
      submitting: false,                 // Checkout submission state
    },

    // ---------------------------------------------------------
    // Lifecycle Hook: Load lessons on startup
    // ---------------------------------------------------------
    mounted() {
      this.fetchLessons();
    },

    // ---------------------------------------------------------
    // Watchers
    // ---------------------------------------------------------
    watch: {
      // Real-time search as user types
      searchTerm(newTerm) {
        this.searchLessons(newTerm);
      }
    },

    // ---------------------------------------------------------
    // Methods: Data fetching, cart handling, checkout, etc.
    // ---------------------------------------------------------
    methods: {

      // -------------------------------------------------------
      // Fetch all lessons from backend 
      // -------------------------------------------------------
      async fetchLessons() {
        this.loading = true;
        try {
          const res = await fetch(`${this.BACKEND_URL}/lessons`);
          this.lessons = await res.json();
        } catch (e) {
          this.error = e.message;
        } finally {
          this.loading = false;
        }
      },

      // -------------------------------------------------------
      // Full-text search 
      // - Runs on every keystroke
      // - Returns lessons whose subject, location, price or space match
      // -------------------------------------------------------
      async searchLessons(term) {
        // Empty input to reset search results
        if (!term.trim()) {
          this.searchResults = [];
          this.noResults = false;
          return;
        }

        try {
          const res = await fetch(`${this.BACKEND_URL}/search?q=${encodeURIComponent(term)}`);
          const results = await res.json();

          this.searchResults = results;
          this.noResults = results.length === 0;
        } catch (e) {
          this.error = e.message;
        }
      },

      // -------------------------------------------------------
      // CART FUNCTIONS
      // -------------------------------------------------------

      // Add one lesson to cart
      addToCart(lesson) {
        if (this.canAddToCart(lesson)) {
          this.cart.push(lesson._id);
        }
      },

      // Remove one instance of a lesson from cart
      removeFromCart(lesson) {
        const idx = this.cart.indexOf(lesson._id);
        if (idx > -1) {
          this.cart.splice(idx, 1);
        }
      },

      // Check if lesson still has available space left
      canAddToCart(lesson) {
        return lesson.spaces > this.cartCount(lesson._id);
      },

      // Count how many times a lesson appears in the cart
      cartCount(id) {
        return this.cart.filter(x => x === id).length;
      },

      // Toggle lesson list to shopping cart view
      toggleCart() {
        this.showProduct = !this.showProduct;
      },

      // -------------------------------------------------------
      // SUBMIT ORDER
      // Steps:
      // 1. POST order data to backend (/orders)
      // 2. For each lesson, update space via PUT (/lessons/:id)
      // 3. Clear cart & refresh lessons
      // -------------------------------------------------------
      async submitOrder() {
        // Prevent submission unless all fields valid
        if (!this.isValidName || !this.isValidPhone || this.cart.length === 0) return;

        this.submitting = true;

        try {
          // -------------------------------
          // Build a map { lessonId: qty }
          // -------------------------------
          const itemsMap = {};
          this.cart.forEach(id => {
            itemsMap[id] = (itemsMap[id] || 0) + 1;
          });

          // Convert map to array for backend
          const items = Object.entries(itemsMap).map(([lessonId, qty]) => ({
            lessonId,
            qty,
          }));

          // ---------------------------------------------------
          // 1. SUBMIT ORDER (POST)
          // ---------------------------------------------------
          const res = await fetch(`${this.BACKEND_URL}/orders`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: this.order.name.trim(),
              phone: this.order.phone.trim(),
              address: this.order.address.trim(),
              items,
            }),
          });

          // If backend returns error message
          if (!res.ok) {
            const msg = await res.text();
            throw new Error(msg || "Order submission failed");
          }

          // ---------------------------------------------------
          // 2. UPDATE LESSON SPACES (PUT) 
          // ---------------------------------------------------
          for (const item of items) {
            const lesson = this.lessons.find(l => l._id === item.lessonId);
            if (lesson) {
              const newSpaces = lesson.spaces - item.qty;

              await fetch(`${this.BACKEND_URL}/lessons/${lesson._id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ spaces: newSpaces }),
              });
            }
          }

          // ---------------------------------------------------
          // Successfully submitted
          // ---------------------------------------------------
          this.orderSubmitted = true;
          this.cart = [];
          this.order = { name: "", phone: "", address: "" };

          // Reload updated lessons from backend
          await this.fetchLessons();

        } catch (e) {
          alert(e.message);
        } finally {
          this.submitting = false;
        }
      }
    },

    // ---------------------------------------------------------
    // Computed Properties: Sorting, filtering, validation, totals
    // ---------------------------------------------------------
    computed: {

      // Number of items currently in cart
      itemInCart() {
        return this.cart.length || 0;
      },

      // Return lessons sorted and matching search
      filteredAndSortedLessons() {
        const base = this.searchTerm.trim()
          ? this.searchResults   
          : this.lessons;

        const modifier = this.sortOrder === "asc" ? 1 : -1;

        return base.slice().sort((a, b) => {
          // Custom handling for "spaces" since cart temporarily reduces them
          if (this.sortAttribute === "spaces") {
            const aSpaces = a.spaces - this.cartCount(a._id);
            const bSpaces = b.spaces - this.cartCount(b._id);
            return (aSpaces - bSpaces) * modifier;
          }

          // Standard sorting for subject, price, location
          if (a[this.sortAttribute] < b[this.sortAttribute]) return -1 * modifier;
          if (a[this.sortAttribute] > b[this.sortAttribute]) return 1 * modifier;
          return 0;
        });
      },

      // Lessons currently present in the cart
      cartLessons() {
        return this.lessons.filter(l => this.cart.includes(l._id));
      },

      // Total price of all items in cart
      totalPrice() {
        return this.cart.reduce((sum, id) => {
          const lesson = this.lessons.find(l => l._id === id);
          return sum + (lesson ? lesson.price : 0);
        }, 0);
      },

      // Validate name letters + spaces only
      isValidName() {
        return /^[A-Za-z\s]+$/.test(this.order.name.trim());
      },

      // Validate phone exactly 8 digits
      isValidPhone() {
        return /^[0-9]{8}$/.test(this.order.phone.trim());
      }
    }
  });
  </script>
</body>
</html>
