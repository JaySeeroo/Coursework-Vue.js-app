<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
  <link rel="stylesheet" href="styles.css" />
  <title>Lessons App</title>
</head>
<body>
  <div id="webstore">
    <header>
      <h1>{{ message }}</h1>
      <button
        @click="toggleCart"
        :disabled="showProduct && cart.length === 0"
        class="cart-toggle-btn"
      >
        <span class="fa-solid fa-cart-shopping"></span>
        <span class="cart-count">{{ itemInCart }}</span>
        <span class="btn-text">{{ showProduct ? 'View Cart' : 'Back to Lessons' }}</span>
      </button>
    </header>

    <main>
      <!-- Lessons list -->
      <div v-if="showProduct">
        <div class="sort-controls">
          <label for="sortAttribute">Sort by:</label>
          <select v-model="sortAttribute" id="sortAttribute">
            <option value="subject">Subject</option>
            <option value="location">Location</option>
            <option value="price">Price</option>
            <option value="spaces">Spaces</option>
          </select>

          <label for="sortOrder">Order:</label>
          <select v-model="sortOrder" id="sortOrder">
            <option value="asc">Ascending</option>
            <option value="desc">Descending</option>
          </select>

          <label for="search">Search:</label>
          <input id="search" v-model="searchTerm" placeholder="Search subject or location" />
        </div>

        <div v-if="loading" class="cart-info">Loading lessons...</div>
        <div v-else-if="error" class="cart-info">{{ error }}</div>

        <div v-else>
          <div v-for="lesson in filteredAndSortedLessons" :key="lesson._id" class="lesson-card">
            <h2>{{ lesson.subject }}</h2>
            <p><strong>Location:</strong> {{ lesson.location }}</p>
            <p><strong>Price:</strong> ${{ lesson.price }}</p>
            <p><strong>Spaces Left:</strong> {{ lesson.spaces - cartCount(lesson._id) }}</p>

            <button @click="addToCart(lesson)" v-if="canAddToCart(lesson)">Add to Cart</button>
            <button disabled v-else>Add to Cart</button>
          </div>
        </div>
      </div>

      <!-- Cart page -->
      <div v-else class="cart-page">
        <h2>Your Shopping Cart</h2>

        <div v-if="orderSubmitted">
          <p class="confirmation">âœ… Your order has been submitted successfully!</p>
        </div>

        <div v-else>
          <div v-if="cart.length > 0">
            <div v-for="lesson in cartLessons" :key="lesson._id" class="lesson-card">
              <h2>{{ lesson.subject }}</h2>
              <p><strong>Location:</strong> {{ lesson.location }}</p>
              <p><strong>Price:</strong> ${{ lesson.price }}</p>
              <p>Quantity: {{ cartCount(lesson._id) }}</p>
              <button @click="removeFromCart(lesson)">Remove One</button>
            </div>

            <div class="cart-summary">
              <p>Total Items: {{ itemInCart }}</p>
              <p>Total Price: ${{ totalPrice }}</p>
            </div>

            <div class="checkout-form">
              <h3>Checkout</h3>
              <p>
                <label for="name">Name:</label>
                <input id="name" v-model="order.name" placeholder="Enter your name" />
              </p>
              <p>
                <label for="phone">Phone:</label>
                <input id="phone" v-model="order.phone" placeholder="Enter your phone" />
              </p>
              <button
                @click="submitOrder"
                :disabled="!isValidName || !isValidPhone || submitting"
              >
                {{ submitting ? 'Submitting...' : 'Checkout' }}
              </button>
            </div>
          </div>
          <div v-else>
            <p>Your cart is empty.</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const BACKEND_URL = "http://localhost:3000";

    new Vue({
      el: "#webstore",
      data: {
        message: "Welcome to the Lessons Store!",
        showProduct: true,
        sortAttribute: "subject",
        sortOrder: "asc",
        searchTerm: "",
        cart: [],
        order: { name: "", phone: "" },
        orderSubmitted: false,
        lessons: [],
        loading: false,
        error: "",
        submitting: false,
      },
      mounted() {
        this.fetchLessons();
      },
      methods: {
        async fetchLessons() {
          this.loading = true;
          this.error = "";
          try {
            const res = await fetch(`${BACKEND_URL}/api/lessons`);
            if (!res.ok) throw new Error("Failed to fetch lessons");
            this.lessons = await res.json();
          } catch (e) {
            this.error = e.message;
          } finally {
            this.loading = false;
          }
        },
        addToCart(lesson) {
          if (this.canAddToCart(lesson)) this.cart.push(lesson._id);
        },
        removeFromCart(lesson) {
          const idx = this.cart.indexOf(lesson._id);
          if (idx > -1) this.cart.splice(idx, 1);
        },
        canAddToCart(lesson) {
          return lesson.spaces > this.cartCount(lesson._id);
        },
        cartCount(lessonId) {
          return this.cart.filter((id) => id === lessonId).length;
        },
        toggleCart() {
          this.showProduct = !this.showProduct;
        },
        async submitOrder() {
          if (!this.isValidName || !this.isValidPhone || this.cart.length === 0) return;
          this.submitting = true;
          try {
            // group cart items by lessonId with qty
            const itemsMap = {};
            this.cart.forEach((id) => {
              itemsMap[id] = (itemsMap[id] || 0) + 1;
            });
            const items = Object.entries(itemsMap).map(([lessonId, qty]) => ({
              lessonId,
              qty,
            }));

            const res = await fetch(`${BACKEND_URL}/api/orders`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name: this.order.name.trim(),
                phone: this.order.phone.trim(),
                items,
              }),
            });
            if (!res.ok) {
              const msg = await res.text();
              throw new Error(msg || "Order submission failed");
            }
            this.orderSubmitted = true;
            this.cart = [];
            this.order.name = "";
            this.order.phone = "";
            await this.fetchLessons(); // refresh spaces after successful order
          } catch (e) {
            alert(e.message);
          } finally {
            this.submitting = false;
          }
        },
      },
      computed: {
        itemInCart() {
          return this.cart.length || 0;
        },
        filteredAndSortedLessons() {
          const term = this.searchTerm.trim().toLowerCase();
          const filtered = term
            ? this.lessons.filter(
                (l) =>
                  l.subject.toLowerCase().includes(term) ||
                  l.location.toLowerCase().includes(term)
              )
            : this.lessons.slice();

          const modifier = this.sortOrder === "asc" ? 1 : -1;

          return filtered.sort((a, b) => {
            if (this.sortAttribute === "spaces") {
              const aSpaces = a.spaces - this.cartCount(a._id);
              const bSpaces = b.spaces - this.cartCount(b._id);
              if (aSpaces < bSpaces) return -1 * modifier;
              if (aSpaces > bSpaces) return 1 * modifier;
              return 0;
            }
            if (a[this.sortAttribute] < b[this.sortAttribute]) return -1 * modifier;
            if (a[this.sortAttribute] > b[this.sortAttribute]) return 1 * modifier;
            return 0;
          });
        },
        cartLessons() {
          return this.lessons.filter((l) => this.cart.includes(l._id));
        },
        totalPrice() {
          return this.cart.reduce((sum, id) => {
            const lesson = this.lessons.find((l) => l._id === id);
            return sum + (lesson ? lesson.price : 0);
          }, 0);
        },
        isValidName() {
          return /^[A-Za-z\s]+$/.test(this.order.name.trim());
        },
        isValidPhone() {
          return /^[0-9]+$/.test(this.order.phone.trim());
        },
      },
    });
  </script>
</body>
</html>
